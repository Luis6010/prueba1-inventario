<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Protege Bien - Inventario</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');
        body { font-family: 'Montserrat', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    const { useState, useEffect, useMemo, useRef } = React;

        // --- COMPONENTE: BARRA DE DISPONIBILIDAD ---
        const StockBar = ({ actuales, totales }) => {
            const porcentaje = totales > 0 ? Math.min((actuales / totales) * 100, 100) : 0;
            let colorBarra = "bg-[#4a90e2]"; 
            if (porcentaje < 20) colorBarra = "bg-rose-500";
            else if (porcentaje < 50) colorBarra = "bg-amber-500";

            return (
                <div className="w-full mt-2 font-montserrat">
                    <div className="flex justify-between text-[9px] mb-1 font-bold text-slate-400 uppercase tracking-tighter">
                        <span>Disponibilidad</span>
                        <span className="text-[#002d5b]">{Math.round(porcentaje)}%</span>
                    </div>
                    <div className="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                        <div className={`h-full transition-all duration-700 ${colorBarra}`} style={{ width: `${porcentaje}%` }}></div>
                    </div>
                </div>
            );
        };

        function App() {
            const estructuraEmpresa = {
                "Tecnolog√≠a (TI)": ['Laptops', 'CPU', 'Celulares', 'Monitores', 'Teclados', 'Mouse', 'Cables', 'Impresoras', 'Telefonos', 'Mousepad', 'Extension', 'Cargadores', 'Adaptadores', 'Escaneres', 'Soporte Laptop', 'Soporte Pantalla', 'Pantalla', 'Repetidores', 'Preamplificadores', 'Switch', 'Alexa', 'Fuente Alimentacion', 'Memoria USB', 'Router', 'Camara', 'Disco', 'Trituradora', 'Convertidor', 'Transmisor', 'Control'],
                "Direccion": ['Paquetes Alcanfores', 'Paquetes Cerveza', 'Paquetes Para Tasas', 'Vinos', 'Tasas', 'Listones']
            };

            const [inventario, setInventario] = useState(() => {
                const datosGuardados = localStorage.getItem('it_inventory_data');
                return datosGuardados ? JSON.parse(datosGuardados) : [];
            });

            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [categoriaActiva, setCategoriaActiva] = useState("General");
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editandoId, setEditandoId] = useState(null);
            const [busqueda, setBusqueda] = useState("");
            const [busquedaRubro, setBusquedaRubro] = useState("");
            const [filtroBajoStock, setFiltroBajoStock] = useState(false);
            const [deptsAbiertos, setDeptsAbiertos] = useState({ "Tecnolog√≠a (TI)": true, "Direccion": false });
            const [nuevoEquipo, setNuevoEquipo] = useState({ idEtiqueta: '', categoria: '', nombre: '', modelo: '', stock: 0, funcionales: 0, noFuncionales: 0, asignado: '' });

            useEffect(() => {
                localStorage.setItem('it_inventory_data', JSON.stringify(inventario));
            }, [inventario]);

            const obtenerTotal = (filtro) => {
                return inventario
                    .filter(item => Array.isArray(filtro) ? filtro.includes(item.categoria) : item.categoria === filtro)
                    .reduce((acc, current) => acc + Number(current.stock), 0);
            };

            const estadisticasVistaActual = useMemo(() => {
                const items = inventario.filter((item) => {
                    if (categoriaActiva === "General") return true;
                    if (estructuraEmpresa[categoriaActiva]) return estructuraEmpresa[categoriaActiva].includes(item.categoria);
                    return item.categoria === categoriaActiva;
                });
                return {
                    total: items.reduce((acc, curr) => acc + Number(curr.stock), 0),
                    ok: items.reduce((acc, curr) => acc + Number(curr.funcionales), 0),
                    baja: items.reduce((acc, curr) => acc + Number(curr.noFuncionales), 0)
                };
            }, [inventario, categoriaActiva]);

            const inventarioFiltrado = useMemo(() => {
                const term = busqueda.toLowerCase().trim();
                return inventario.filter((item) => {
                    let cumpleRubro = categoriaActiva === "General" || (estructuraEmpresa[categoriaActiva] ? estructuraEmpresa[categoriaActiva].includes(item.categoria) : item.categoria === categoriaActiva);
                    const matchId = item.idEtiqueta?.toLowerCase().includes(term);
                    const matchNombre = item.nombre.toLowerCase().includes(term);
                    const cumpleBajoStock = !filtroBajoStock || (item.stock > 0 && (item.funcionales / item.stock) < 0.2);
                    return cumpleRubro && (matchId || matchNombre) && cumpleBajoStock;
                });
            }, [inventario, categoriaActiva, busqueda, filtroBajoStock]);

            const guardarEquipo = (e) => {
                e.preventDefault();
                const stockTotal = Number(nuevoEquipo.funcionales) + Number(nuevoEquipo.noFuncionales);
                const data = { ...nuevoEquipo, stock: stockTotal, id: editandoId || Date.now() };
                if (editandoId) setInventario(prev => prev.map(i => i.id === editandoId ? data : i));
                else setInventario(prev => [...prev, data]);
                setIsModalOpen(false);
            };

            const toggleDepto = (dept) => {
                setDeptsAbiertos(prev => ({ ...prev, [dept]: !prev[dept] }));
            };

            const rubrosDisponibles = useMemo(() => Object.values(estructuraEmpresa).flat(), []);

            return (
                <div className="h-screen bg-[#f8fafc] flex overflow-hidden text-[#002d5b]">
                    {/* Sidebar Mejorado */}
                    <aside className={`fixed inset-y-0 left-0 z-50 w-72 bg-[#002d5b] text-white transform transition-transform duration-300 lg:relative lg:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full shadow-2xl'}`}>
                        <div className="p-8 border-b border-white/5">
                            <h2 className="text-xl font-black italic text-[#4a90e2] mb-4">PROTEGE BIEN</h2>
                            <input 
                                type="text" 
                                placeholder="Buscar rubro..." 
                                className="w-full bg-white/10 rounded-lg px-3 py-2 text-[10px] outline-none border border-white/10"
                                value={busquedaRubro}
                                onChange={(e) => setBusquedaRubro(e.target.value)}
                            />
                        </div>
                        <nav className="p-4 space-y-2 overflow-y-auto h-[calc(100vh-160px)]">
                            <button onClick={() => {setCategoriaActiva("General"); setIsSidebarOpen(false);}} className={`w-full text-left py-3 px-4 rounded-xl text-[11px] font-black ${categoriaActiva === "General" ? 'bg-[#4a90e2]' : 'hover:bg-white/5 text-slate-400'}`}>üìä PANEL GENERAL</button>
                            
                            {Object.entries(estructuraEmpresa).map(([dept, rubros]) => (
                                <div key={dept} className="mb-2">
                                    <div className="flex justify-between items-center px-4 py-2 bg-white/5 rounded-t-xl">
                                        <button onClick={() => {setCategoriaActiva(dept); setIsSidebarOpen(false);}} className="text-[10px] font-black text-[#4a90e2] uppercase">{dept}</button>
                                        <button onClick={() => toggleDepto(dept)} className="text-xs">{deptsAbiertos[dept] ? '‚ñ≤' : '‚ñº'}</button>
                                    </div>
                                    {deptsAbiertos[dept] && (
                                        <div className="bg-white/5 rounded-b-xl pb-2">
                                            {rubros.filter(r => r.toLowerCase().includes(busquedaRubro.toLowerCase())).map(r => (
                                                <button key={r} onClick={() => {setCategoriaActiva(r); setIsSidebarOpen(false);}} className="w-full text-left py-2 pl-8 pr-4 text-[11px] text-slate-400 hover:text-white">{r}</button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </nav>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0 overflow-hidden">
                        <header className="bg-white border-b p-4 lg:p-10">
                            <div className="flex justify-between items-center mb-6">
                                <button onClick={() => setIsSidebarOpen(true)} className="lg:hidden text-2xl">‚ò∞</button>
                                <h1 className="text-xl font-black uppercase italic tracking-tighter truncate">{categoriaActiva}</h1>
                                <button onClick={() => {setEditandoId(null); setIsModalOpen(true);}} className="bg-[#002d5b] text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase shadow-md">+ Nuevo</button>
                            </div>
                            {/* Estad√≠sticas */}
                            <div className="grid grid-cols-3 gap-2 mb-6">
                                <div className="bg-slate-50 p-3 rounded-2xl border text-center">
                                    <span className="text-[8px] font-black text-slate-400 block uppercase">Total</span>
                                    <span className="text-lg font-black">{estadisticasVistaActual.total}</span>
                                </div>
                                <div className="bg-[#d1e3f8]/40 p-3 rounded-2xl border text-center">
                                    <span className="text-[8px] font-black text-[#4a90e2] block uppercase">Disp.</span>
                                    <span className="text-lg font-black text-[#4a90e2]">{estadisticasVistaActual.ok}</span>
                                </div>
                                <div className="bg-rose-50 p-3 rounded-2xl border text-center">
                                    <span className="text-[8px] font-black text-rose-400 block uppercase">Baja</span>
                                    <span className="text-lg font-black text-rose-600">{estadisticasVistaActual.baja}</span>
                                </div>
                            </div>
                            <input type="text" placeholder="Buscar..." className="w-full p-3 bg-slate-100 rounded-xl text-sm" value={busqueda} onChange={e => setBusqueda(e.target.value)} />
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                            {inventarioFiltrado.map(item => (
                                <div key={item.id} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 relative">
                                    <div className="flex justify-between mb-2">
                                        <span className="bg-[#4a90e2] text-white text-[8px] px-2 py-0.5 rounded font-black">ID: {item.idEtiqueta || 'S/ID'}</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => {setEditandoId(item.id); setNuevoEquipo(item); setIsModalOpen(true);}}>‚úèÔ∏è</button>
                                            <button onClick={() => {if(confirm('¬øEliminar?')) setInventario(p => p.filter(i => i.id !== item.id))}}>üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <h3 className="font-black italic text-[#002d5b]">{item.nombre}</h3>
                                    <div className="grid grid-cols-3 gap-2 mt-3">
                                        <div className="bg-[#002d5b] text-white p-2 rounded-xl text-center font-black text-base">{item.stock}</div>
                                        <div className="bg-[#d1e3f8] text-[#0056b3] p-2 rounded-xl text-center font-black text-base">{item.funcionales}</div>
                                        <div className="bg-rose-50 text-rose-600 p-2 rounded-xl text-center font-black text-base">{item.noFuncionales}</div>
                                    </div>
                                    <StockBar actuales={item.funcionales} totales={item.stock} />
                                </div>
                            ))}
                        </div>

                        {isModalOpen && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-end lg:items-center justify-center">
                                <div className="bg-white w-full max-w-lg rounded-t-3xl lg:rounded-3xl p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="font-black italic uppercase">Nuevo Activo</h2>
                                        <button onClick={() => setIsModalOpen(false)} className="text-xl">‚úï</button>
                                    </div>
                                    <form onSubmit={guardarEquipo} className="space-y-4">
                                        <input className="w-full p-4 bg-slate-100 rounded-xl font-bold" placeholder="ID Etiqueta" value={nuevoEquipo.idEtiqueta} onChange={e => setNuevoEquipo({...nuevoEquipo, idEtiqueta: e.target.value})} />
                                        <input required className="w-full p-4 bg-slate-100 rounded-xl font-bold" placeholder="Nombre / Marca" value={nuevoEquipo.nombre} onChange={e => setNuevoEquipo({...nuevoEquipo, nombre: e.target.value})} />
                                        <div className="grid grid-cols-2 gap-4">
                                            <input type="number" className="w-full p-4 bg-slate-100 rounded-xl font-black text-center" placeholder="OK" value={nuevoEquipo.funcionales} onChange={e => setNuevoEquipo({...nuevoEquipo, funcionales: e.target.value})} />
                                            <input type="number" className="w-full p-4 bg-slate-100 rounded-xl font-black text-center" placeholder="BAJA" value={nuevoEquipo.noFuncionales} onChange={e => setNuevoEquipo({...nuevoEquipo, noFuncionales: e.target.value})} />
                                        </div>
                                        <button type="submit" className="w-full py-5 bg-[#002d5b] text-white font-black rounded-xl shadow-lg">GUARDAR</button>
                                    </form>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
</body>
</html>